# CVE-2018-11360 (Wireshark)

## Root Cause Analysis

A heap-based buffer overflow vulnerability existed in the file `epan/dissectors/packet-gsm_a_dtap.c`. This type of vulnerability occurs when a program writes more data to a buffer located in the heap than what is actually allocated for that buffer.

The affected function is as follows:

```C
static guint16 de_sub_addr(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, guint32 offset, guint len, gchar **extracted_address)
{
    /**
    * Reduced for space reasons.
    **/
        
    *extracted_address = (gchar *)wmem_alloc(wmem_packet_scope(), ia5_string_len);
    
    /**
    * Reduced for space reasons.
    **/

    IA5_7BIT_decode(*extracted_address, ia5_string, ia5_string_len);

    /**
    * Reduced for space reasons.
    **/
```

At line 2324, memory is allocated using:

```C
*extracted_address = (gchar *)wmem_alloc(wmem_packet_scope(), ia5_string_len);
```

This allocation requests `ia5_string_len` bytes. However, at line 2338, the function `IA5_7BIT_decode()` is called:

```C
IA5_7BIT_decode(*extracted_address, ia5_string, ia5_string_len);
```

The function `IA5_7BIT_decode()`, implemented in `epan/strutil.c` at line 1183, is defined as:

```C
IA5_7BIT_decode(unsigned char * dest, const unsigned char* src, int len)
{
    int i, j;
    gunichar buf;

    for (i = 0, j = 0; j < len;  j++) {
        buf = char_def_ia5_alphabet_decode(src[j]);
        i += g_unichar_to_utf8(buf,&(dest[i]));
    }
    dest[i]=0;
    return;
}
```

At line 1192, the line:

```C
dest[i]=0;
```

writes a null terminator at index `i`, which evaluates to `ia5_string_len + 1`, causing an **off-by-one error**. Since the original allocation was only `ia5_string_len` bytes, this results in a buffer overflow.

To prevent this, an extra byte was allocated to account for the null terminator:

```C
static guint16 de_sub_addr(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, guint32 offset, guint len, gchar **extracted_address)
{
    /**
    * Reduced for space reasons.
    **/
        
    *extracted_address = (gchar *)wmem_alloc(wmem_packet_scope(), ia5_string_len + 1);
    
    /**
    * Reduced for space reasons.
    **/

    IA5_7BIT_decode(*extracted_address, ia5_string, ia5_string_len);

    /**
    * Reduced for space reasons.
    **/
}
```

## Installing The Vulnerable Version

1. We clone the repository:

```C
git clone https://gitlab.com/wireshark/wireshark.git Wireshark
```

2. We navigate into the project directory:

```C
cd Wireshark
```

3. We find the commit related to the vulnerability (using the first 7 characters of the commit ID provided above). I would like to view the 5 lines before and after the concerned commit for better context:

```C
git log --graph --oneline --all | grep -B 5 -A 5 "a55b36c"
```

> | * ee971ce1da Make the two file type descriptions for WTAP_FILE_TYPE_SUBTYPE_MPLOG the same.
> 
> | * 6647728d79 [Automatic update for 2018-05-20]
> 
> | * af6e6237f4 Get rid of add_async_dns_ipv4().
>
> | * 2f56988f01 Make private variables static.
>
> | * beaebe91b1 proto.c: do not dereference a NULL pointer in proto_item_get_len() on first pass
>
> | * **a55b36c51f** gsm_a_dtap: fix off-by-one buffer overflow (write)
>
> | * ab8a33ef08 tvbuff: make tvb_bytes_exist fail with negative values
>
> | * 4425716ddb dns: fix null pointer deref for empty name in SRV record
>
> | * 5f8bd0c94f DNS: replace g_strsplit by wmem_strsplit
>
> | * ccb1ac3c8c Q.931: fix use-after-free (write) of "q931_pi"
>
> | * 14f1a1d749 [Automatic update for 2018-05-13]

Now, we should see the commit `a55b36c` for **CVE-2018-11360**.

4. We `checkout` the commit before the patch to retrieve the vulnerable version. Note that we `checkout` the `ab8a33ef08` commit, not the `beaebe91b1` commit, because the git graph is read vertically from bottom to top:

```C
git checkout ab8a33ef08
```

Eventually, we have the vulnerable version of **Wireshark** before the fix for **CVE-2018-11360** was applied. Now, we are ready to dive in.

### Building

According to the official Wireshark repository, we first need to ensure that **Qt 5.15** or **later** and **GLib 2.x** development packages are installed.

Wireshark requires **Qt 5.15** or **later**, but our system had **5.12.8** one. So, we installed **Qt 5.15.2** from [here](https://www.qt.io/offline-installers).

When building against **Qt 5**, the CMake option `-DUSE_qt6=OFF` must be specified:

```C
mkdir build && cd build
cmake -DUSE_qt6=OFF ..
make -j$(nproc)
```

During the build process, we encountered several missing header issues, which we resolved as follows:

**Error #1:** 
> error: invalid use of incomplete type ‘const class QAction’

**Solution:** Add the following line to `/ui/qt/about_dialog.cpp`:
```C
#include <QAction>
```

**Error #2:**
> error: aggregate ‘QStyleOption style_opt’ has incomplete type and cannot be defined

**Solution:** Add the following line to `/ui/qt/packet_format_group_box.cpp`:
```C
#include <QStyleOption>
```

**Error #3:**
> error: ‘QStyleOption’ was not declared in this scope
> 
> error: invalid use of incomplete type ‘class QStyle’

**Solution:** Add the following line to `/ui/qt/time_shift_dialog.cpp`
```C
#include <QStyleOption>
#include <QStyle>
```

**Error #4:**
> error: invalid use of incomplete type ‘class QAbstractItemView’

**Solution:** Add the following line to `/ui/qt/wireless_frame.cpp`
```C
#include <QAbstractItemView>
```

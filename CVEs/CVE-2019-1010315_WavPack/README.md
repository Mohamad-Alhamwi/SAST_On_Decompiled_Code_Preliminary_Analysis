# CVE-2019-1010315 (WavPack)

## Root Cause Analysis

A division by zero bug vulnerability existed in the file `cli/dsdiff.c`. 

The affected function is as follows:

```C
int ParseDsdiffHeaderConfig (FILE *infile, char *infilename, char *fourcc, WavpackContext *wpc, WavpackConfig *config)
{
	/**
	* Reduced for space reasons.
	**/
	
	else if (!strncmp (dff_chunk_header.ckID, "DSD ", 4))
	{
		total_samples = dff_chunk_header.ckDataSize / config->num_channels;
		break;
	}

	/**
	* Reduced for space reasons.
	**/
}
```

At line 282, `config->num_channels` is used in a division operation without prior validation, which could lead to a division-by-zero error.

This issue was addressed by adding a validation check, ensuring `config->num_channels` is not zero before performing the division:

```C
int ParseDsdiffHeaderConfig (FILE *infile, char *infilename, char *fourcc, WavpackContext *wpc, WavpackConfig *config)
{
	/**
	* Reduced for space reasons.
	**/
	
	else if (!strncmp (dff_chunk_header.ckID, "DSD ", 4))
	{
		if (!config->num_channels)
		{
		    error_line ("%s is not a valid .DFF file!", infilename);
		    return WAVPACK_SOFT_ERROR;
		}

		total_samples = dff_chunk_header.ckDataSize / config->num_channels;
		break;
	}

	/**
	* Reduced for space reasons.
	**/
}
```

## Installing The Vulnerable Version

1. We clone the repository:

```C
git clone https://github.com/dbry/WavPack.git WavPack
```

2. We navigate into the project directory:

```C
cd WavPack
```

3. We find the commit related to the vulnerability (using the first 7 characters of the commit ID provided above). I would like to view the 5 lines before and after the concerned commit for better context:

```C
git log --graph --oneline --all | grep -B 5 -A 5 "4c0faba"
```

> \* 685f55f issue #72: fix gcc 9 compile warnings
>
> \* a0e0e1b issue #69: add TPUB (Publisher) to accepted ID3v2 tag fields
> 
> \* bc6cba3 issue #67: make sure sample rate is specified and non-zero in DFF files
> 
> \* 33a0025 issue #68: clear WaveHeader at start to prevent uninitialized read
>
>  \* f68a955 issue #66: make sure CAF files have a "desc" chunk
>
> \* **4c0faba** issue #65: make sure DSDIFF files have a valid channel count
>
> \*   8948be9 Merge pull request #62 from jrlanglois/Copyright2019
>
> |\
>
> | * 944dd17 Updated Copyright notice to 2019.
>
> |/
>
> \*   00d9a4a Merge pull request #61 from evpobr/cmake-fix-masm64

Now, we should see the commit `4c0faba` for **CVE-2019-1010315**.

4. We `checkout` the commit before the patch to retrieve the vulnerable version. Note that we `checkout` the `8948be9` commit, not the `f68a955` commit, because the git graph is read vertically from bottom to top:

```C
git checkout 8948be9
```

Eventually, we have the vulnerable version of **WavPack** before the fix for **CVE-2019-1010315** was applied. Now, we are ready to dive in.
